#!/bin/sh
#
# Pre-commit hook for WhiteIPTV KMP
#
# This hook automatically formats code with ktlint and runs detekt
# before allowing a commit to proceed.
#

echo "ğŸ” Running pre-commit checks..."

# Get list of staged Kotlin files
STAGED_KOTLIN_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.kt[s"]\?$' || true)

if [ -z "$STAGED_KOTLIN_FILES" ]; then
    echo "âœ… No Kotlin files to check"
    exit 0
fi

echo "ğŸ“ Formatting Kotlin files with ktlint..."
./gradlew ktlintFormat --daemon --quiet

if [ $? -ne 0 ]; then
    echo "âŒ ktlint format failed"
    exit 1
fi

echo "ğŸ”¬ Running Detekt static analysis..."
./gradlew detekt --daemon --quiet

if [ $? -ne 0 ]; then
    echo "âŒ Detekt checks failed"
    echo "ğŸ’¡ Fix the issues or run './gradlew detektBaseline' to create a baseline"
    exit 1
fi

# Re-add any files that were formatted
echo "âœ¨ Re-staging formatted files..."
for file in $STAGED_KOTLIN_FILES; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done

echo "âœ… Pre-commit checks passed!"
exit 0
